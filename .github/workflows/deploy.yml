name: Deploy to Cloud Run

on:
  push:
    branches: [ "main" ]

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SA_EMAIL }}

      - uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker
        run: gcloud auth configure-docker ${{ secrets.GCP_REGION }}-docker.pkg.dev

      - name: Build and Push Gateway
        run: |
          IMAGE="${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ secrets.GCP_ARTIFACT_REPO }}/dryrun-gateway:${{ github.sha }}"
          docker build -f server/Dockerfile -t "$IMAGE" server
          docker push "$IMAGE"

      - name: Deploy Gateway
        run: |
          IMAGE="${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ secrets.GCP_ARTIFACT_REPO }}/dryrun-gateway:${{ github.sha }}"
          ENV_VARS="CORS_ORIGIN=${{ secrets.GATEWAY_CORS_ORIGIN }}~SUPABASE_JWKS_URL=${{ secrets.SUPABASE_JWKS_URL }}~SUPABASE_JWT_ISSUER=${{ secrets.SUPABASE_JWT_ISSUER }}~GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}"
          if [ -n "${{ secrets.OPENAI_API_KEY }}" ]; then
            ENV_VARS="$ENV_VARS~OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}"
          fi
          if [ -n "${{ secrets.REDIS_URL }}" ]; then
            ENV_VARS="$ENV_VARS~REDIS_URL=${{ secrets.REDIS_URL }}"
          fi
          gcloud run deploy dryrun-gateway \
            --image "$IMAGE" \
            --region "${{ secrets.GCP_REGION }}" \
            --platform managed \
            --allow-unauthenticated \
            --set-env-vars "^~^$ENV_VARS"

      - name: Resolve Gateway URL
        id: gateway_url
        run: |
          URL=$(gcloud run services describe dryrun-gateway --region "${{ secrets.GCP_REGION }}" --format="value(status.url)")
          echo "gateway_url=$URL" >> "$GITHUB_OUTPUT"

      - name: Build and Push Web
        run: |
          IMAGE="${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ secrets.GCP_ARTIFACT_REPO }}/dryrun:${{ github.sha }}"
          docker build \
            --build-arg VITE_SUPABASE_URL="${{ secrets.VITE_SUPABASE_URL }}" \
            --build-arg VITE_SUPABASE_ANON_KEY="${{ secrets.VITE_SUPABASE_ANON_KEY }}" \
            --build-arg VITE_BACKEND_GATEWAY_URL="${{ steps.gateway_url.outputs.gateway_url }}" \
            --build-arg GEMINI_API_KEY="${{ secrets.GEMINI_API_KEY }}" \
            -t "$IMAGE" .
          docker push "$IMAGE"

      - name: Deploy Web
        run: |
          IMAGE="${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ secrets.GCP_ARTIFACT_REPO }}/dryrun:${{ github.sha }}"
          gcloud run deploy dryrun-web \
            --image "$IMAGE" \
            --region "${{ secrets.GCP_REGION }}" \
            --platform managed \
            --allow-unauthenticated
